apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: ingress
spec:
  profile: empty # Do not install CRDs or the control plane
  components:
    ingressGateways:
      - name: ingressgateway
        namespace: eventbus
        enabled: true
        label:
          # Set a unique label for the gateway. This is required to ensure Gateways
          # can select this workload
          istio: ingressgateway
  values:
    gateways:
      istio-ingressgateway:
        # Enable gateway injection
        injectionTemplate: gateway

#---
#
#apiVersion: v1
#kind: Service
#metadata:
#  name: eventbus-ingressgateway-service
#spec:
#  selector:
#    istio: ingressgateway
#  ports:
#    - protocol: TCP
#      port: 80
#      targetPort: 8081
#  type: LoadBalancer


---

apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: eventbus-gateway
  namespace: eventbus
spec:
  selector:
    app: istio-ingressgateway
  servers:
    - port:
        number: 8080
        name: http
        protocol: HTTP
      hosts:
        - "*"

---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: rabbit-rule
  namespace: eventbus
spec:
  hosts:
    - "*"
  gateways:
    - eventbus/eventbus-gateway
  http:
    - match:
      - uri:
          prefix: /
      rewrite:
        uri: "/"
      route:
        - destination:
            port:
              number: 15672 # can be omitted if it's the only port for reviews
            host: rabbitmq-cluster1.eventbus.svc.cluster.local
          weight: 100
